<link rel="import" href="../bower_components/polymer/polymer.html">
<link rel="import" href="../bower_components/iron-flex-layout/iron-flex-layout.html">

<link rel="import" href="../bower_components/paper-drawer-panel/paper-drawer-panel.html">
<link rel="import" href="../bower_components/paper-header-panel/paper-header-panel.html">
<link rel="import" href="../bower_components/paper-toolbar/paper-toolbar.html">

<link rel="import" href="../bower_components/google-signin/google-signin.html">
<link rel="import" href="../bower_components/discovery-api-elements/discovery-api-elements.html">

<link rel="import" href="../bower_components/iron-icons/iron-icons.html">
<link rel="import" href="../bower_components/iron-icons/hardware-icons.html">
<link rel="import" href="../bower_components/iron-icon/iron-icon.html">
<link rel="import" href="../bower_components/paper-icon-button/paper-icon-button.html">

<link rel="import" href="folder-menu.html">

<dom-module id="drive-viewer">
  <style>
    :host {
      @apply(--layout-fit);
      font-family: 'RobotoDraft','Roboto',arial,sans-serif;
    }

    paper-toolbar [title] {
      font-weight: bold;
      font-size: 1.2em;
      @apply(--layout-flex);
    }

    .user {
      @apply(--layout-horizontal);
      @apply(--layout-center);
    }
    .user img {
      height: 40px;
      width: 40px;
      margin-left: 10px;
      margin-right: 10px;
      border-radius: 50%;
    }

    main {
      padding: 10px;
    }

    core-scaffold::shadow core-header-panel {
      background-color: white;
    }

    core-scaffold core-header-panel[navigation] {
      background-color: #eee;
    }

    core-scaffold.noUser::shadow core-drawer-panel::shadow #drawer {
      display: none;
    }

    core-scaffold.noUser::shadow core-drawer-panel::shadow #main {
      left: 0;
    }

    core-scaffold.noUser::shadow #menuButton {
      display: none;
    }

    #folders {
      padding-top: 10px;
      transition: opacity ease-in-out 0.3s
    }

    #folders.inactive {
      opacity: 0.5;
    }

    .folder {
      padding: 5px;
      cursor: pointer;
      background-color: rgba(0,0,0,0);
      border-bottom: 1px solid #ccc;
      transition: padding ease-in-out 0.3s, background-color ease-in-out 0.3s;
    }

    .folder.active {
      font-weight: bold;
      padding: 10px 5px;
      background-color: yellow;
    }

    .folder:hover {
      background-color: rgba(0,0,0,0.1);
    }

    .file:hover {
      background-color: rgba(0,0,0,0.1);
    }

    .file {
      border-bottom: 1px solid #ccc;
    }

    paper-icon-button::shadow core-icon div {
      background-repeat: no-repeat;
    }

    a {
      text-decoration: none;
    }

    a:hover {
      text-decoration: underline;
    }
  </style>
  <template>

    <discovery-api-elements
      name="drive"
      version="v2"
      loaded="{{elementsReady}}"
      ></discovery-api-elements>

    <drive-apps-list response="{{appsResponse}}" auto$="[[allReady(signedIn, elementsReady)]]"></drive-apps-list>

    <paper-drawer-panel>
      <paper-header-panel drawer>
        <paper-toolbar><span title>Folders</span></paper-toolbar>
        <div id="folders">
          <folder-menu folder-id="root" title="My Drive" depth="1" on-show-files="showFiles" id="rootFolder"></folder-menu>
        </div>
      </paper-header-panel>
      <paper-header-panel main>
        <paper-toolbar>
          <paper-icon-button icon="menu" paper-drawer-toggle></paper-icon-button>
          <div title>Google Drive Viewer</div>
          <div hidden$="[[!signedIn]]" class="user">
            <span>[[user.name]]</span>
            <img src$="[[user.image]]">
          </div>
          <google-signin
            id="signinButton"
            client-id="[[clientId]]"
            scopes="[[scopes]]"
            signed-in="{{signedIn}}"
          ></google-signin>
        </paper-toolbar>
        <main>
          <template if="{{currentFolder && currentFolder.id != 'root'}}">
            <div layout horizontal center class="file" on-click="{{navigateUp}}">
              <paper-icon-button icon="arrow-back"></paper-icon-button>
            </div>
          </template>
          <template repeat="{{file in files}}">
            <div layout horizontal center class="file">
              <a href="{{file.alternateLink}}" target="_blank" on-click="{{openFile}}"><paper-icon-button iconSrc="{{file.iconLink}}"></paper-icon-button></a>
              <span flex><a href="{{file.alternateLink}}" target="_blank" on-click="{{openFile}}">{{file.title}}</a></span>
              <template repeat="{{app in file.apps}}">
                <core-tooltip label="{{apps[app.id].name}}" position="left">
                  <a href="{{app.link}}" target="_blank"><paper-icon-button iconSrc="{{apps[app.id].icon}}"></paper-icon-button></a>
                </core-tooltip>
              </template>
            </div>
          </template>
        </main>
      </paper-header-panel>
    </paper-drawer-panel>
  </template>
</dom-module>

<script>
  (function (global) {
    Polymer({
      is: 'drive-viewer',
      properties: {
        clientId: String,
        scopes: {
          type: String,
          value: function () {
            return [
              'profile', 'email',
              'https://www.googleapis.com/auth/drive.readonly',
              'https://www.googleapis.com/auth/drive.apps.readonly'
            ].join(' ');
          }
        },
        signedIn: {
          type: Boolean,
          observer: 'loadHandler'
        },
        elementsReady: {
          type: Boolean,
          observer: 'loadHandler'
        },
        user: Object,
        files: Array,
        apps: {
          type: Object,
          computed: 'appsFromApi(signedIn, appsResponse)'
        },
        filesResponse: {
          type: Object,
          observer: 'filesChanged'
        },
        currentFolder: Object
      },

      loadHandler: function () {
        if (!this.signedIn || !this.elementsReady) {
          this.user = undefined;
          this.folders = [];
          this.files = [];
          this.currentFolder = undefined;
          return;
        }
        var profile = gapi.auth2.getAuthInstance().currentUser.get().getBasicProfile();
        this.user = {
          name: profile.getName(),
          image: profile.getImageUrl()
        };

        this.folders = [];
        this.files = [];

        this.$.rootFolder.display();
      },

      allReady: function (signedIn, elementsReady) {
        return signedIn && elementsReady;
      },

      appsFromApi: function (signedIn, response) {
        var apps = {};
        if (!signedIn) {
          // Just in case the user signed out right after signing in while the request was running
          return undefined;
        }
        if (response && response.items) {
          for (i = 0; i < response.items.length; i++) {
            if (response.items[i].icons && response.items[i].icons.length > 0) {
              icon = response.items[i].icons[0].iconUrl;
              for (j = 0; j < response.items[i].icons.length; j++) {
                if (response.items[i].icons[j].category == 'application' &&
                    response.items[i].icons[j].size >= 24) {
                      icon = response.items[i].icons[j].iconUrl;
                      break;
                }
              }
              apps[response.items[i].id] = {
                name: response.items[i].name,
                icon: icon
              };
            }
          }
        }
        return apps;
      },

      displayRoot: function () {
        this.rootFolder = {
          id: 'root',
          title: 'My Drive',
          depth: 1
        };
        this.displayFolder(this.rootFolder);
      },
      folderClick: function (e) {
        this.displayFolder(e.model.folder);
      },
      toggleDisplay: function (e) {
        var folder = e.model.folder;
        if (!folder.filesChecked) {
          this.displayFolder(folder);
        } else {
          folder.showChildren = !folder.showChildren;
        }
      },
      navigateUp: function (e) {
        this.displayFolder(this.currentFolder.parent);
      },
      filesChanged: function (response) {
        var i, app;
        var folder = this.checkedFolder;
        folder.filesChecked = true;

        this.updating = false;
      },
      openFile: function (e) {
        var file = e.model.file;
        if (file.mimeType == 'application/vnd.google-apps.folder') {
          e.preventDefault();
          this.displayFolder(file);
        }
      }
    });
  }(this));
</script>
